digraph finite_state_machine {
    // VISUAL OPTIONS
    //  splines=line; // force straight line edges

    node [shape = doublecircle]; START; // indicate Base=start state
    node [shape = circle];

    // FOLLOW
    subgraph cluster_follow {
        label = "follow cluster";
        node [style=filled, color=white];
        style=filled;
        color=lightgrey;

        Follow -> Wait [ label = "loses user legs" ];
        Wait -> Follow [ label = "sees user card" ];
        Follow -> Register_Product [ label = "product fiducial" ];
        Register_Product -> Product_Warning [ label = "product warning (balance, allergy, not recognized)" ];
        Follow -> Guide_To_Product [ label = "user asks to be guided to product" ];
        Guide_To_Product -> Wait [ label = "arrives at product" ];
        Product_Warning -> Follow [ label = "user acknowledges warning" ];
        Register_Product -> Follow [ label = "product registered successfully" ];
        Wait -> Timeout [ label = "no user card seen in X min" ];
        Follow -> Nav_Error [ label = "bumper event" ]; // hit something
        Guide_To_Product -> Nav_Error [ label = "bumper event" ];
        Nav_Error -> Follow [ label = "employee reorients robot" ];


    }

    // BASE
    START -> Base [ label = "initialized" ];
    Base -> Login [ label = "sees customer card" ];
    Login -> Follow [ label = "customer chooses follow" ];
    Login -> Auto_Shop [ label = "customer chooses to have robot shop autonomously" ];

    Follow -> Checkout [ label = "User hits checkout button" ];
    Auto_Shop -> Checkout [ label = "0 remaining items on list" ];
    Checkout -> Base [ label = "customer has removed all items from cart" ];

    // AUTOSHOPPER
    subgraph cluster_autoshop {
        label = "autoshop cluster";
        node [style=filled, color=lightgrey];
        Auto_Shop -> Auto_Nav_To_Product [ label = "robot chooses item to find" ];

        Auto_Nav_To_Product -> Auto_Wait [ label = "ask user to put item in cart" ];
        Auto_Wait -> Auto_Register [ label = "fiducial detected" ];
        Auto_Register -> Auto_Shop [ label = "no error in product registration" ];
        Auto_Register -> Auto_Register [ label = "can't recognize fiducial" ];
        // TODO nav error

    }
}
